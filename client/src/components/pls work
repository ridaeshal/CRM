import React, { useState, useEffect } from 'react';

const API_BASE_URL = 'http://localhost:8000/api';

const customerService = {
  getAll: async () => {
    try {
      const response = await fetch(`${API_BASE_URL}/customers`);
      if (!response.ok) throw new Error('Failed to fetch customers');
      return response.json();
    } catch (error) {
      console.error(error);
      throw error;
    }
  },
  create: async (data) => {
    try {
      const response = await fetch(`${API_BASE_URL}/customers`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data),
      });
      if (!response.ok) throw new Error('Failed to create customer');
      return response.json();
    } catch (error) {
      console.error(error);
      throw error;
    }
  },
  update: async (id, data) => {
    try {
      const response = await fetch(`${API_BASE_URL}/customers/${id}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data),
      });
      if (!response.ok) throw new Error('Failed to update customer');
      return response.json();
    } catch (error) {
      console.error(error);
      throw error;
    }
  },
  delete: async (id) => {
    try {
      const response = await fetch(`${API_BASE_URL}/customers/${id}`, {
        method: 'DELETE',
      });
      if (!response.ok) throw new Error('Failed to delete customer');
      return response.json();
    } catch (error) {
      console.error(error);
      throw error;
    }
  },
  getAllTags: async () => {
    try {
      const response = await fetch(`${API_BASE_URL}/tags`);
      if (!response.ok) throw new Error('Failed to fetch tags');
      return response.json();
    } catch (error) {
      console.error(error);
      return [];
    }
  },
};

const Modal = ({ isOpen, onClose, title, children }) => {
  if (!isOpen) return null;
  return (
    <div className="modal-overlay" onClick={onClose}>
      <div className="modal-content" onClick={e => e.stopPropagation()}>
        <div className="modal-header">
          <h2>{title}</h2>
          <button className="close-btn" onClick={onClose}>&times;</button>
        </div>
        <div className="modal-body">{children}</div>
      </div>
    </div>
  );
};

const CustomerForm = ({ customer, allTags = [], onSubmit, onCancel }) => {
  const [formData, setFormData] = useState({
    name: '',
    email: '',
    phone: '',
    company: '',
    notes: '',
    accountNumber: '',
    tags: [],
  });
  const [errors, setErrors] = useState({});

  useEffect(() => {
    if (customer) {
      setFormData({
        ...customer,
        accountNumber: customer.account?.accountNumber || '',
        tags: customer.tags?.map(tag => tag.id) || [],
      });
    }
  }, [customer]);

  const handleChange = (e) => {
    const { name, value, type, selectedOptions } = e.target;
    if (type === 'select-multiple') {
      const values = Array.from(selectedOptions).map(o => parseInt(o.value));
      setFormData(prev => ({ ...prev, [name]: values }));
    } else {
      setFormData(prev => ({ ...prev, [name]: value }));
    }
    if (errors[name]) setErrors(prev => ({ ...prev, [name]: '' }));
  };

  const validate = () => {
    const newErrors = {};
    if (!formData.name.trim()) newErrors.name = 'Name is required';
    if (!formData.email.trim()) newErrors.email = 'Email is required';
    if (formData.email && !/\S+@\S+\.\S+/.test(formData.email))
      newErrors.email = 'Email is invalid';
    if (!formData.accountNumber.trim())
      newErrors.accountNumber = 'Account number is required';
    return newErrors;
  };

  const handleSubmit = () => {
    const newErrors = validate();
    if (Object.keys(newErrors).length > 0) {
      setErrors(newErrors);
      return;
    }
    // Transform for backend: nest account and tags
    const payload = {
      ...formData,
      account: { accountNumber: formData.accountNumber },
      tags: formData.tags,
    };
    onSubmit(payload);
  };

  return (
    <div className="customer-form">
      {['name', 'email', 'phone', 'company', 'notes', 'accountNumber'].map(field => (
        <div className="form-group" key={field}>
          <label>{field.charAt(0).toUpperCase() + field.slice(1)}{field === 'name' || field === 'email' || field === 'accountNumber' ? ' *' : ''}</label>
          {field === 'notes' ? (
            <textarea name="notes" value={formData.notes} onChange={handleChange} className={errors.notes ? 'error' : ''}></textarea>
          ) : (
            <input
              type={field === 'email' ? 'email' : 'text'}
              name={field}
              value={formData[field]}
              onChange={handleChange}
              className={errors[field] ? 'error' : ''}
            />
          )}
          {errors[field] && <span className="error-text">{errors[field]}</span>}
        </div>
      ))}

      <div className="form-group">
        <label>Tags</label>
        <select name="tags" multiple value={formData.tags} onChange={handleChange}>
          {allTags.map(tag => (
            <option key={tag.id} value={tag.id}>{tag.name}</option>
          ))}
        </select>
      </div>

      <div className="form-actions">
        <button className="btn btn-secondary" onClick={onCancel}>Cancel</button>
        <button className="btn btn-primary" onClick={handleSubmit}>
          {customer ? 'Update' : 'Create'} Customer
        </button>
      </div>
    </div>
  );
};

const CustomerPage = () => {
  const [customers, setCustomers] = useState([]);
  const [tags, setTags] = useState([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null);
  const [searchTerm, setSearchTerm] = useState('');
  const [modalState, setModalState] = useState({ isOpen: false, mode: null, customer: null });

  useEffect(() => {
    fetchCustomers();
    fetchTags();
  }, []);

  const fetchCustomers = async () => {
    setLoading(true);
    try {
      const data = await customerService.getAll();
      setCustomers(data);
    } catch (err) {
      setError(err.message);
    } finally {
      setLoading(false);
    }
  };

  const fetchTags = async () => {
    try {
      const data = await customerService.getAllTags();
      setTags(data);
    } catch (err) {
      console.error(err);
    }
  };

  const openModal = (mode, customer = null) => setModalState({ isOpen: true, mode, customer });
  const closeModal = () => setModalState({ isOpen: false, mode: null, customer: null });

  const handleCreate = async (formData) => {
    try {
      await customerService.create(formData);
      await fetchCustomers();
      closeModal();
    } catch (err) { setError(err.message); }
  };

  const handleUpdate = async (formData) => {
    try {
      await customerService.update(modalState.customer.id, formData);
      await fetchCustomers();
      closeModal();
    } catch (err) { setError(err.message); }
  };

  const handleDelete = async () => {
    try {
      await customerService.delete(modalState.customer.id);
      await fetchCustomers();
      closeModal();
    } catch (err) { setError(err.message); }
  };

  const filteredCustomers = customers.filter(c =>
    c.name?.toLowerCase().includes(searchTerm.toLowerCase()) ||
    c.email?.toLowerCase().includes(searchTerm.toLowerCase()) ||
    c.company?.toLowerCase().includes(searchTerm.toLowerCase())
  );

  return (
    <div className="customer-page">
      <div className="page-header">
        <h1>Customer Management</h1>
        <button className="btn btn-primary" onClick={() => openModal('create')}>+ Add Customer</button>
      </div>

      <input type="text" className="search-input" placeholder="Search..." value={searchTerm} onChange={e => setSearchTerm(e.target.value)} />

      {error && <div className="alert alert-error">{error}</div>}
      {loading ? <div>Loading...</div> : (
        <table className="data-table">
          <thead>
            <tr>
              <th>Name</th><th>Email</th><th>Phone</th><th>Company</th><th>Account</th><th>Tags</th><th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {filteredCustomers.length === 0 ? <tr><td colSpan="7">No customers found</td></tr> :
              filteredCustomers.map(c => (
                <tr key={c.id}>
                  <td>{c.name}</td>
                  <td>{c.email}</td>
                  <td>{c.phone || 'N/A'}</td>
                  <td>{c.company || 'N/A'}</td>
                  <td>{c.account?.accountNumber || 'N/A'}</td>
                  <td>{c.tags?.map(t => t.name).join(', ') || 'N/A'}</td>
                  <td>
                    <button onClick={() => openModal('edit', c)}>‚úèÔ∏è</button>
                    <button onClick={() => openModal('delete', c)}>üóëÔ∏è</button>
                  </td>
                </tr>
              ))
            }
          </tbody>
        </table>
      )}

      <Modal isOpen={modalState.isOpen && (modalState.mode === 'create' || modalState.mode === 'edit')}
        onClose={closeModal}
        title={modalState.mode === 'create' ? 'Add Customer' : 'Edit Customer'}
      >
        <CustomerForm
          customer={modalState.customer}
          allTags={tags}
          onSubmit={modalState.mode === 'create' ? handleCreate : handleUpdate}
          onCancel={closeModal}
        />
      </Modal>

      <Modal isOpen={modalState.isOpen && modalState.mode === 'delete'}
        onClose={closeModal} title="Delete Customer"
      >
        <div>
          <p>Are you sure you want to delete <strong>{modalState.customer?.name}</strong>?</p>
          <div className="form-actions">
            <button className="btn btn-secondary" onClick={closeModal}>Cancel</button>
            <button className="btn btn-danger" onClick={handleDelete}>Delete</button>
          </div>
        </div>
      </Modal>
    </div>
  );
};

export default function App() {
  return <CustomerPage />;
}
